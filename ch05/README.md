# Chap05. V8引擎

V8引擎是Node的心臟，它為Node撰寫可擴充的高性能伺服器提供了基本動力。本章探討它的特性以及這些特性對程式的影響做一個深入探討。了解這些，有助於避開錯誤，提升程式執行效率。

## JavaScript程式的編譯與最佳化

Node可以看作是JavaScript的執行時期環境。一方面，它提供了多種可呼叫的API，如讀寫檔案、網路請求、系統資訊等。另一方面，因為CPU執行的是機器碼，它還負責將JavaScript程式解釋成機器指令序列執行，這部分工作是由V8引擎完成。V8引擎是Node的心臟，其誕生之初的目標，就是**加強指令稿的執行效率**，它甚至直接將程式編譯為本機機器碼，以節省一般指令碼語言解釋執行的時間。

### 即時編譯

V8採用即時編譯技術(JIT)，直接將JavScript程式編譯成本地平台的機器碼。巨觀上看，其步驟為JavaScript原始程式->抽象語法樹->本機機器碼，並且後一個步驟只依賴前一個步驟。這與其他解譯器不同，例如Java語言須先將原始程式編譯成位元組碼，然後給JVM解釋執行，JVM根據最佳化策略，執行過程中有選擇地將一部分位元組碼編譯成本地機器碼。V8不產生中間程式，過程如下：

JavaScript source code -> 抽象語法樹 -> 機器指令

V8設計之初，是加快Chrome瀏覽器執行網頁尾本的效率，當網頁載入完成，V8一步合格，編譯成機器碼，CPU就開始執行了。比起產生中間碼解釋執行的方式，V8的策略省去一個步驟，程式會更早地開始執行。並且執行編譯好的機器指令，也比解釋執行中間碼的速度更快。不足的事，**缺少位元碼這個中間表示**，**使得程式最佳化變得更困難**。

### 隱藏類別

類別是被熟知的概念，這裡加上「隱藏」兩字修飾，我們可以先考慮，什麼是不隱藏的類別。那應該是C++/Java這種靜態類型語言中，開發者定義的類別。這些靜態類型語言的每一個變數，都有一個唯一確定的類型。因為有類型資訊，一個物件包含哪些成員和這些成員在物件中的偏移量等資訊，編譯階段就可確定，即時執行CPU只需要用物件起始位址——C++中是this指標，加上成員在物件內部的偏移量即可存取內部成員。這些存取指令在編譯階段就產生了。

但對於JavaScript這種動態語言，變數在執行時期可以隨時由不同類型的物件設定值，並且物件本身可以隨時增刪成員。**存取物件屬性需要的資訊完全由執行時期決定**。為了實現按照索引的方式存取成員，V8「悄悄地」給執行中的物件分了類別，在這個過程中產生了一種**V8內部的資料結構**，即**隱藏類別**。**隱藏類別本身是一個物件**。

當定義一個建置函數，使用這個函數產生第一個物件的時候，V8會為它初始化一個隱藏類別。以後使用這個建置函數產生的物件指在同一個隱藏類別。但假如程式中對某個物件增加或刪除某些屬性，V8立即建立一個新的隱藏類別，改變之後的物件指向新建立的隱藏類別。

可見，隱藏類別造成給物件分組的作用。同一組的物件，具有相同的成員名稱。隱藏類別紀錄了成員名稱和偏移量，根據這些資訊，V8能夠按照物件起始位址＋偏移量存取成員變數。在程式中，存取物件成員是非常頻繁的操作，相比於把屬性名稱作為鍵值，使用字典尋找的方式存取成員，使用索引的方式對效能的改進更明顯。

### 內聯快取

借助隱藏類別，可以使用陣列索引的方式存取物件成員。但成員的索引值是以雜湊表的方式儲存在隱藏類別中。如果每次存取屬性都搜尋隱藏類別的雜湊表，那麼這個使用偏移量的方式不會帶來任何好處。內聯快取是以程式執行為基礎的局部性原理，動態產生使用索引尋找的程式。下一次存取成員就不必再去搜尋雜湊表。可以用兩段虛擬程式碼描述這個過程：

```c++

```